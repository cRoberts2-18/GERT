{% extends "layout.html" %}
{% block content %}

<div id="mySidebar" class="sidebar" style="width:300px; padding-top:20px; overflow-y: hidden; position:absolute;">
  <input class="sidebutton" type="Button" id="MapText" value="Map" onclick="Map()">&emsp;<input class="sidebutton" type="button" id="ViewData" value="Data" onclick="Data()"><br><br><br>	
  <a id="searchText" style="text-align:center;">Coordinates Selected </a>
  <label id="LongLabel" for="long">Longitude 1: </label><br><input class="number" type="number" name="long" id="Long" value="-1.266" readonly><br>
  <label id="LatLabel" for="lat">Latitude 1: </label><br><input class="number" type="number" name="lat" id="Lat" value="52.9" readonly><br><br>
  <label id="LongLabel2" for="long2">Longitude 2: </label><br><input class="number" type="number" name="long2" id="Long2" value="-1.18" readonly><br>
  <label id="LatLabel2" for="lat2">Latitude 2: </label><br><input class="number" type="number" name="lat2" id="Lat2" value="52.74" readonly><br><br>	
  <input class="buttonstyle" type="button" style=" margin:auto;" id = "GetData" value = "Get Location Data">
  
</div>

<div id="map" class='map'></div>
<div id="Data"></div>
	
<script>
let boxClickCounter = 0;	


    function notifyMessage(msg,styles){
                 $.notify(msg,{
                 className: styles,
                 globalPosition: 'right center'
                        
                 });
     }
	
	
	
	function Data(){	  
	  document.getElementById("map").style.display="none";
	  document.getElementById("Data").style.display="block";	
	  }
	function Map(){	  
	  document.getElementById("map").style.display="block";
	  document.getElementById("Data").style.display="none";
	  }

	 var map = L.map('map',{
        center: [52.770775, -1.2043467],
        zoom: 5,
        zoomControl: false
	    
    });
    L.control.zoom({position: 'topright'}).addTo(map);
    
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(map);
    
    var boundingBox = L.rectangle([[52.8, -1.266], [52.74, -1.18]], {color: "#ff00dd", weight: 1});
	  map.addLayer(boundingBox);
	
	  var xy1 = [52.8, -1.266];
	  var xy2 = [52.74, -1.18];
	  var boxBounds = [xy1, xy2];   

	

function onMapClickFirst(e) {
	lat=parseFloat(e.latlng.wrap().lat);
	lon=parseFloat(e.latlng.wrap().lng);
	xy1 = xy2;
	xy2 = e.latlng.wrap();
	boxBounds = [xy1, xy2];
        notifyMessage("You clicked the map at " + e.latlng.wrap(), "info");
	boxClickCounter++;
	if (boxClickCounter == 3) {
		xy1 = [0,0];
		xy2 = [0,0];
		document.getElementById("Lat").value=0;
		document.getElementById("Long").value=0;
		document.getElementById("Lat2").value=0;
		document.getElementById("Long2").value=0;
		boxClickCounter = 0;
		boxBounds = [xy1, xy2];
		boundingBox.setBounds(boxBounds);
	}
	if (boxClickCounter == 2) {
		boxBounds = [xy1, xy2];
		boundingBox.setBounds(boxBounds);
		document.getElementById("Lat2").value=lat;
		document.getElementById("Long2").value=lon;
	}
	if (boxClickCounter == 1) {
		document.getElementById("Lat").value=lat;
		document.getElementById("Long").value=lon;
	}
    }
    
    map.on('click', onMapClickFirst);

	
$(function() {
		$("#GetData").click(function () {
			var $PLACElat = parseFloat($("#Lat").val()); 
    			var $PLACElong = parseFloat($("#Long").val());
			var $PLACElat2 = parseFloat($("#Lat2").val()); 
    			var $PLACElong2 = parseFloat($("#Long2").val());
			var $lat=0;
			var $long=0;
			var $lat2=0;
			var $long2=0;
			if($PLACElat<$PLACElat2){
				$lat=$PLACElat-0.2;
				$lat2=$PLACElat2+0.2;
			}else{
				$lat=$PLACElat2-0.2;
				$lat2=$PLACElat+0.2;
			}
			
			if($PLACElong<$PLACElong2){
				$long=$PLACElong;
				$long2=$PLACElong2;
			}else{
				$long=$PLACElong2;
				$long2=$PLACElong;
			}
			
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			var $ID = urlParams.get('ID');
			var $path = "{{ download }}";
    	   	$.ajax({
    			method: "POST",
      			url: "{{ url_for('searchData')}}",
			data: {"lat":$lat, "lat2":$lat2, "long":$long, "long2":$long2, "path":$path, "ID":$ID}
      			
   		})
		.done(function(msg) {
			Data();
			var splitData=[];
			var splitData2=new Array(2);
			var splitData3=new Array(2);
			const dataArray=msg.split("!")
			var table="<table id=\"data\" class=\"SaveTable\" style=\"float:right;\"><thead><tr>";
			for (let i = 0; i < dataArray.length; i++){
				var split=dataArray[i].split(":");
				if (typeof split[1] !== 'undefined'){
					table+="<th>"+split[0]+"</th>";
					splitData[i]=split[1]
				}
			}
			for (let i = 0; i < splitData.length; i++){
				splitData2[i]=new Array(2);
				if(typeof splitData[i] !== 'undefined'){	
					splitData[i]=splitData[i].replaceAll(" [","!");
					var split1=splitData[i].split("!");
					for (let j = 1; j < split1.length; j++){
						split1[j]=split1[j].replaceAll("[","");
						split1[j]=split1[j].replaceAll("]","");
						splitData2[i][j-1]=split1[j];
						
					}
				}
			}
			table+="</tr></thead><tbody>"
			
			for (let i = 0; i < splitData2[0].length; i++){
				
				for (let j = 0; j < splitData2.length; j++){
					if(i==0){
						splitData3[j]=new Array(2);
					}
					if(typeof splitData2[j][i] !== 'undefined'){
						var split2=splitData2[j][i].split(" ");
						console.log(split2);
						for (let k = 1; k < split1.length; k++){
							splitData3[j][k-1]=split2[k];
						}	
					}
				}
			}
			
			for (let i = 0; i < splitData3[0].length; i++){
				var writeline=true;
				table+="<tr>";
				for (let j = 0; j < splitData3.length; j++){
					if (typeof splitData3[j][i] == 'undefined' || splitData3[j][i] == ""){
						writeline=false
					}
				}
				if(writeline==true)
					for (let j = 0; j < splitData3.length; j++){
						table+="<td>"+splitData3[j][i]+"</td>";
					}
				table+="</tr>";
			
			}
			
			
			
			
			
			
			
			document.getElementById("Data").innerHTML=table;
			document.getElementById("mySidebar").style.height="3000px";
		})   
		.fail(function(msg){
			alert(msg);
		});
		});
 
	});	
	
	
</script>
{% endblock %}
